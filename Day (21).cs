using AoC2023;
using System.Numerics;
using static AoC2023.Utils;

var fullInput =
@"...................................................................................................................................
.#........#.#.........#................##.#.............#....................#....#....#.#...#.......#..........#........#.........
....#......#.....................##...#.#....#.#..#...#.......................#.....#..........##....#..#........#.##..#..#...#....
.#.....#.............#.#...............#...........#.#.#................#...........#.#.....#.......##......#........#.#...........
.....#...........#.......##.#.#..........#....#....#..#.#..................................#....##...#.#.....#..#.......#...#...#..
...#....##............#...#..#.....#....##....#....##...........#...............#..##..#..............#..#......#.....#............
..##....#.........#.......#..#...#...........................................#.....#.#........#...#.......................#.....#..
..##.#........#..........#......#...#.....#..#.......#........................#..........##......#...#.#..............#......#.....
........#....##.................................#.##.........#.......#........#...#..#.....................#.#.##....#.........#...
.#...............#....#..........#....#.#...........................................................#.#.....#...#...#.........#....
..#........#.##..............#...##.....#..#...#....................................#..##......#..#.......#........................
...........................................#.................#.#..................#..#..#..#....#..#................#..........#...
.....#...#...#.#......#.....#.#.....#.#..#........................#..#.##...................#.................................#.#..
......#...........#.........##....#.#.#....#..............#........#....................#.............#..##...#.............#......
..#...........##....#......#..#........................#.#........#..#...#...........#............................#.#............#.
.#....#..#......#..........................#.......................#....#...........#......#.......#...............................
....#.#...##....#.........#....#...#.#..#............................#.......#...............................................#..#..
.......#..........##......#..#...#.....#............#...#...................#...............#..#..................#.....#..#...#...
..................#.........#....#.#....#..#....................#..................................................................
.#.##.................#....#..#.......##.#.................#.#............#...#..........#.#...#.........##.#...............#......
..#........#.....#.#.........#.#.....#..#........#...#.....#....#....#.....................##....#...............................#.
..#...#....#.#.............#..#..#...............##.......##.........#.....................................#....###.....##....#....
....#..####.....#....................#................#.......#.............#..#..#..........##......##.......#...........#........
..........##..#........#.......#..............#.#......#..#....#.............#...#................#......##...#..#......#..........
......#....#...#........#.............................##..#.....#..............#.#......................................##.#...#...
.#..........................................#.......#...#.##..#............#.......................#.#...##........................
............#.#...........#.....#....................##...#...#....#.................#.#.........#......#........#......#...#......
.#.....##.#..#..........#....##............#...........#.#.....#.......#............#.#............#...............................
.........#........#...#.###.....#.........#.#...##.##....##..........#................................#..........#...##...#........
...........#.........##...#.#..................................................#.........#..................#.........#.......#....
....##...#..#.#..#.......................#....#......#............#....#.........###......#..............#.......#...#..........#..
...........#.......#......#...............................#.....#.......#..#...............#.........##........#.#.........#.......
......#....#.................#..............#..#..........#...#........................##..............#.........................#.
.###.##...#.##........#........................#.#.###................#...#.#....#...........#...............##.........#..........
...........................................#.........#..##.................#...#.#.#..##..#............#.#.#.....##.....#..........
.#............................................#..#............#....#...#...#......#.#..........................#....#.#..........#.
...........#...........#................#........#..........#........#...........#..............#.........#....##....#....#...##.#.
................#............................#...#......#.....................#..............#.........................##..#...#...
...#....#.............................................#..................#.....#.#..#.....#................#.......#....#..........
.#....##..#.#.......#.............#..............#...#..#....................#..#........#.#.......................................
.#...#.......................................................#..........#.........#.......##...#.#.#............###............#.#.
.....#.....#......#..............#.#...............#....#.....................#......#....#.#........#.........#....#.........#....
............#.#.###.......................................................#...................#....#...#.......##............#.....
.#......#..............................#..........#....#....#.#.#........#............#.....#........................#......#......
................#......................##.......#.......#..#..............##...................#...#...#...........................
.#...#..................#.......................#...#...#..........#.......#.......#...................##...................#......
........#...............#...#....................#..#.......................#.............#.#.#..........#..........###........#.#.
.#..##...#..#............#.....#.....................#......#..............#......#..#..............#.....................#........
....#...###.....................###..........#....#....#..............#................#.#.......#.#....##............#......#.#...
......#.....................#.......#.#.#...#....#...#.#.....#..#........##.#..#..#......##........................................
.......#.#............#...........#........#..............#....##..##..................##..........#...........#.......#..#..#...#.
..#..#......................#..................................#....#......#...#............##......#......................##...#..
.#...............................#.#.........#.....................###.#..................##.#...#.......#....................#..#.
......##................#.........#......#................#........#.....#....#.#.##..#..#...##...#.#...........#................#.
..#..#.........#...............##..................#........................................#........#......##.....................
...................#....#......#...................#.#.....#..............#....##................#......#...#......#.........#.....
....#...........#.......#......#..........#.....................#..#.........##.....##...........###......##.......................
.................#..#....#..##.........................................#......#..........#............#..#....#.................#..
.............#..#........#..#..#.#.......#..........#...........#..#.........#.#...................###.....#.......................
..#............#..#..#..#..................#.##.#...#.#...#............###......#........................#.........#..#.........#..
...........#..##.#..#.............#...#.............#.........#.....#.......#..................#...##..##......#...#..#............
..............#...#...#.....##....#.#........#................#.....#.....#......#.......##....#.....#......#..#....#..............
.............#....#..##..#.................#....#.#......#.#......#...##.....#....###.......#.......#..............................
............................#..........#.......#................#....#.........#.......#.#..................#......................
..........#...#.......#......................................##..........#..#......#............#..............#.....#..#..........
.................................................................S.................................................................
................#.........#.....#........#......................#....#.#.............#....#...#.............#...........#..........
.........................................#......#............#...........#.......#......#..##.........##.............#.............
........#................#.......#..........#.....#..........#........#.................##......#.............#.....#.....#........
........#........#......#.......#....#...##.....................#.........#.....#.........#.................#..#...................
.............#............................#.......#......#...##.........##...#......#.....#.#...#....................#.............
..................................................#......#.......................#..##..#...##........#.#........#.................
.#...........#..#.......#.....#...............#...#.....#..........#...#.#.#.......#.#..........................#.#................
.####...............#...........#......#..#...................#....#....#...........#...#...................#.................#.#..
...............#......#.##...............##..#..#........#..........#.#.............##......#............#...#.....#............#..
.......................#.....###..#....#..#........................................#.#.............#...#........#..................
.....................##....#...............#.........#....#.####...#......#.................#.#...........#......##..........#.#...
..................#.................###...#............................#.#...##..#.#.#..#...#.................................#..#.
....................#..........#..............#............................#.......#.........................#................#....
.#..#...............#.........#..#..........#...#..........##.......##.##.....#....#...#.#......#...##.#...........................
....#...............#....#.............................#.....#.........#..............#......#..............#............#.......#.
........................#...........#..........#...#............#...#.#....#.............##..............##.#...................#..
...#..................#.#...#...#.........#...........#.....#...#.##........#.#....#..........#.......##...........................
.........#.#..........##.#....................#....#................#..#.#.....#...........#.........####.............#.......##...
.#......#...................#........#.......#........#...#..#..........#..##..#..........#........................................
.....#....#..#................##.....#......#.........................#.###...................#..#................#..#......#......
..............#..........................................#.........#.....##.###............#...##.....................##...........
..#......#..#.#.#.........#...#....................#.........#.........#......#...#.....................................#..........
.......#...#.................#..........................#...##..#...#.#.........##............#..................#...............#.
....#.........#.............#.......#.#..........#................#..##.#.#.#...................#.....#............#.....##....#...
.###...............................#.........#..............#.#......#......#.....##.#.#.......#................#.#..............#.
...#........#......#........................#.......#.##...#.........#........#...#.......#..##....#...........#....#..##..........
......#.......#........#.......#..#...#....#.......#....#.#..........##........#..#...............#.......................##..#....
...................#....#..........#........#.............#...#...##...#..........#.......#...#............#..........##...........
.#........##......#.#................#.....#..........#....###................#.....#.......###...............#...#..........#..#..
...#.........#...#....#............#..................##....#......#.....#.......#..........#...#...........#.....#..#.......#.....
........#.................#........#.........#...............#...........#.##...##.......#..................#.......#....##........
.###......#.....#......#.....................##..#...#........#........#....#................................#....#.....#.#........
...........##..............................#..#...........#....#...#......#.#..#......#...............#............................
.....#.#..#.........#............................#.....#.#.##......#.#.........#.....#.#...........................#...##......#.#.
..............#.#.#.....#.#.............#..#.#.....#....#..#.#....#.................#....................#..........#........#.....
..........#.....##.......#................#....................................#..#......#.........#..............#...#......##....
.##.#......###..............#.#...............###......#.................#.......#......#.............................#....#.#.....
..#..#...#............#....##.............#........................#.#..................................#......................#...
......#.....#.............#...#............#....#.......#.....#.................................#..##...#.#..............#.........
...........#..........#..#.#..................##...........#.......#........#....#.............#....................#.....#........
....#...........#........##........................................#.#...............#.............#.#...##...#........#...........
...#..#..............................................................#...#.#...#..#...........#..#..#....#..#..#.......#..#........
...................#.#.....##...........................#................#.#...#...........#.............................#.........
.....###.........#.....#...#...##...#..#........###.....#..#..............#.....#...................#...#...........#...#..........
..............#......................................#..#....#.........##....##..#.......#.......................#.....##..........
..#...................#...........#................................#.....#.#.#..........................#....#......#......#.......
..#......#....#..##..#....#............#...........###........................#.........#........#........#............#.........#.
...................#.##...........#....#..##............#...................#.........#........##........#...........#.#...........
...#.#......#....#........#.......#....................................#.##..#.........#....#.#.....#.........................#..#.
....#.#...#...........................................#...#..#....#....#..............#.........................#.....#......#..#..
......#..................#..........#..#....#.......................#...............#...........#..............#....#.#............
.#..............#........##......#...#....#...#.#................................................#.....##....#...##...#.#........#.
.........#.............#..#..#...........................#.............#...........................#....##............#............
..........#...#.....#..#...#...........#.#.......#........#.....................#.....#.....#...#.#..#......#....#....#...#..#.....
.#........#............##.................##...............#.....................#.##.................#........#......#............
....#........##....#..#.#.........#................................#................#.#.....#.............#..#....##.#....##.......
........#.#.....#.......#.#..##..............##...................#...................#..#....................#..#.......#...#.##..
.....#.#.........#.#....###..#..#.......#.....#................#....#........#.....................#.###.....#...........#......#..
......#...#................#..#...##............#......#...................#............................#.........#....##...##.....
..........#...##.....#....#...........#.....#......#..#.......................##...#.##.....#...#..##...#...#..#..#..........#...#.
......#............#...........#.#..#...............#.............................#..#.......#...#.................#.......#....#..
..............#........#............#....#.....##...#.###...................#............#..#.#..................#.............#...
.............#....#.......#..#......#....#...#..#.......##.............#.##...#.........#..........................#.#...........#.
.#..............#...#......#.......#..#................#.#.............#....#...............#.......#..............................
...................................................................................................................................";

var smallInput =
@"...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........";

var smallest = "";




var xx = new BigInteger(15416) * new BigInteger(202300) * new BigInteger(202300) - new BigInteger(2019) * new BigInteger(202300) + new BigInteger(20971);


var input = smallInput;
//input = fullInput;
//input = smallest;
var timer = System.Diagnostics.Stopwatch.StartNew();

var result = BigInteger.Zero;

var grid = Utils.ParseCoordGrid(input).ToList();
var width = grid.Max(x => x.x) + 1;
var height = grid.Max(x => x.y) + 1;

var unvisitable = grid.Where(x => x.c == '#').Select(x => (x.x, x.y)).ToHashSet();
(int x, int y) Mod((int x, int y) n) => (Utils.SafeMod(n.x, width), Utils.SafeMod(n.y, height));
bool Visitable((int x, int y) n) => !unvisitable.Contains(Mod(n));
var start = grid.Single(x => x.c == 'S');

//Utils.PrintGrid(grid, x => x.x, x => x.y, x => x.c.ToString());

var s = grid.Single(x => x.c == 'S');

var toVisit = new HashSet<(int x, int y)>() { (s.x, s.y) };

//Utils.PrintGrid(toVisit, x => x.x, y => y.y, x => "0", 15, 15, -15, -15, (x, y) => Visitable((x, y)) ? "." : "#");

var toFind = new[] { width/2, (int)(1.5 * width), (int)(2.5 * width), }.ToDictionary(x => x, x => int.MinValue);

var prev = 0;
for (var i = 1; ; i++)
{
    IEnumerable<(int x, int y)> Get((int x, int y) item)
    {
        foreach (var d in new[] { (1, 0), (-1, 0), (0, -1), (0, 1), })
        {
            var newCoord = (item.x + d.Item1, item.y + d.Item2);
            if (!Visitable(newCoord)) { continue; }
            yield return newCoord;
        }
    }
    toVisit = toVisit.SelectMany(Get).ToHashSet();
    Console.WriteLine($"{i} {toVisit.Count}");

    if (toFind.Keys.Contains(i))
    {
        toFind[i] = toVisit.Count;
        if (toFind.All(x => x.Value != int.MinValue))
        {
            //break;
        }
    }
}

// Math stolen from https://www.reddit.com/r/adventofcode/comments/18nevo3/comment/kef317h/
var y0 = toFind.Values.ElementAt(0);
var y1 = toFind.Values.ElementAt(1);
var y2 = toFind.Values.ElementAt(2);

var _C = y2;
var _AplusBplusC = y1;
var _4Aplus2BplusC = y0;

var _AplusB = _AplusBplusC - _C;
var _4Aplus2B = _4Aplus2BplusC - _C;
var _2A = _4Aplus2B - 2 * _AplusB;
var _A = _2A / 2;

var _B = _AplusB - _A;

var targetSteps = 26501365;
var _X = new BigInteger((targetSteps - height/2) / height);


result = _A * _X * _X + _B * _X + _C;


timer.Stop();
Console.WriteLine(result); // 630903862217271 too high
                           // 858243848161716 too high
                           // 858235363318106
                           // 3898608414711471
Console.WriteLine(timer.ElapsedMilliseconds + "ms");
Console.ReadLine();