using AoC2023;
using static AoC2023.Utils;

var fullInput =
@"...................................................................................................................................
.#........#.#.........#................##.#.............#....................#....#....#.#...#.......#..........#........#.........
....#......#.....................##...#.#....#.#..#...#.......................#.....#..........##....#..#........#.##..#..#...#....
.#.....#.............#.#...............#...........#.#.#................#...........#.#.....#.......##......#........#.#...........
.....#...........#.......##.#.#..........#....#....#..#.#..................................#....##...#.#.....#..#.......#...#...#..
...#....##............#...#..#.....#....##....#....##...........#...............#..##..#..............#..#......#.....#............
..##....#.........#.......#..#...#...........................................#.....#.#........#...#.......................#.....#..
..##.#........#..........#......#...#.....#..#.......#........................#..........##......#...#.#..............#......#.....
........#....##.................................#.##.........#.......#........#...#..#.....................#.#.##....#.........#...
.#...............#....#..........#....#.#...........................................................#.#.....#...#...#.........#....
..#........#.##..............#...##.....#..#...#....................................#..##......#..#.......#........................
...........................................#.................#.#..................#..#..#..#....#..#................#..........#...
.....#...#...#.#......#.....#.#.....#.#..#........................#..#.##...................#.................................#.#..
......#...........#.........##....#.#.#....#..............#........#....................#.............#..##...#.............#......
..#...........##....#......#..#........................#.#........#..#...#...........#............................#.#............#.
.#....#..#......#..........................#.......................#....#...........#......#.......#...............................
....#.#...##....#.........#....#...#.#..#............................#.......#...............................................#..#..
.......#..........##......#..#...#.....#............#...#...................#...............#..#..................#.....#..#...#...
..................#.........#....#.#....#..#....................#..................................................................
.#.##.................#....#..#.......##.#.................#.#............#...#..........#.#...#.........##.#...............#......
..#........#.....#.#.........#.#.....#..#........#...#.....#....#....#.....................##....#...............................#.
..#...#....#.#.............#..#..#...............##.......##.........#.....................................#....###.....##....#....
....#..####.....#....................#................#.......#.............#..#..#..........##......##.......#...........#........
..........##..#........#.......#..............#.#......#..#....#.............#...#................#......##...#..#......#..........
......#....#...#........#.............................##..#.....#..............#.#......................................##.#...#...
.#..........................................#.......#...#.##..#............#.......................#.#...##........................
............#.#...........#.....#....................##...#...#....#.................#.#.........#......#........#......#...#......
.#.....##.#..#..........#....##............#...........#.#.....#.......#............#.#............#...............................
.........#........#...#.###.....#.........#.#...##.##....##..........#................................#..........#...##...#........
...........#.........##...#.#..................................................#.........#..................#.........#.......#....
....##...#..#.#..#.......................#....#......#............#....#.........###......#..............#.......#...#..........#..
...........#.......#......#...............................#.....#.......#..#...............#.........##........#.#.........#.......
......#....#.................#..............#..#..........#...#........................##..............#.........................#.
.###.##...#.##........#........................#.#.###................#...#.#....#...........#...............##.........#..........
...........................................#.........#..##.................#...#.#.#..##..#............#.#.#.....##.....#..........
.#............................................#..#............#....#...#...#......#.#..........................#....#.#..........#.
...........#...........#................#........#..........#........#...........#..............#.........#....##....#....#...##.#.
................#............................#...#......#.....................#..............#.........................##..#...#...
...#....#.............................................#..................#.....#.#..#.....#................#.......#....#..........
.#....##..#.#.......#.............#..............#...#..#....................#..#........#.#.......................................
.#...#.......................................................#..........#.........#.......##...#.#.#............###............#.#.
.....#.....#......#..............#.#...............#....#.....................#......#....#.#........#.........#....#.........#....
............#.#.###.......................................................#...................#....#...#.......##............#.....
.#......#..............................#..........#....#....#.#.#........#............#.....#........................#......#......
................#......................##.......#.......#..#..............##...................#...#...#...........................
.#...#..................#.......................#...#...#..........#.......#.......#...................##...................#......
........#...............#...#....................#..#.......................#.............#.#.#..........#..........###........#.#.
.#..##...#..#............#.....#.....................#......#..............#......#..#..............#.....................#........
....#...###.....................###..........#....#....#..............#................#.#.......#.#....##............#......#.#...
......#.....................#.......#.#.#...#....#...#.#.....#..#........##.#..#..#......##........................................
.......#.#............#...........#........#..............#....##..##..................##..........#...........#.......#..#..#...#.
..#..#......................#..................................#....#......#...#............##......#......................##...#..
.#...............................#.#.........#.....................###.#..................##.#...#.......#....................#..#.
......##................#.........#......#................#........#.....#....#.#.##..#..#...##...#.#...........#................#.
..#..#.........#...............##..................#........................................#........#......##.....................
...................#....#......#...................#.#.....#..............#....##................#......#...#......#.........#.....
....#...........#.......#......#..........#.....................#..#.........##.....##...........###......##.......................
.................#..#....#..##.........................................#......#..........#............#..#....#.................#..
.............#..#........#..#..#.#.......#..........#...........#..#.........#.#...................###.....#.......................
..#............#..#..#..#..................#.##.#...#.#...#............###......#........................#.........#..#.........#..
...........#..##.#..#.............#...#.............#.........#.....#.......#..................#...##..##......#...#..#............
..............#...#...#.....##....#.#........#................#.....#.....#......#.......##....#.....#......#..#....#..............
.............#....#..##..#.................#....#.#......#.#......#...##.....#....###.......#.......#..............................
............................#..........#.......#................#....#.........#.......#.#..................#......................
..........#...#.......#......................................##..........#..#......#............#..............#.....#..#..........
.................................................................S.................................................................
................#.........#.....#........#......................#....#.#.............#....#...#.............#...........#..........
.........................................#......#............#...........#.......#......#..##.........##.............#.............
........#................#.......#..........#.....#..........#........#.................##......#.............#.....#.....#........
........#........#......#.......#....#...##.....................#.........#.....#.........#.................#..#...................
.............#............................#.......#......#...##.........##...#......#.....#.#...#....................#.............
..................................................#......#.......................#..##..#...##........#.#........#.................
.#...........#..#.......#.....#...............#...#.....#..........#...#.#.#.......#.#..........................#.#................
.####...............#...........#......#..#...................#....#....#...........#...#...................#.................#.#..
...............#......#.##...............##..#..#........#..........#.#.............##......#............#...#.....#............#..
.......................#.....###..#....#..#........................................#.#.............#...#........#..................
.....................##....#...............#.........#....#.####...#......#.................#.#...........#......##..........#.#...
..................#.................###...#............................#.#...##..#.#.#..#...#.................................#..#.
....................#..........#..............#............................#.......#.........................#................#....
.#..#...............#.........#..#..........#...#..........##.......##.##.....#....#...#.#......#...##.#...........................
....#...............#....#.............................#.....#.........#..............#......#..............#............#.......#.
........................#...........#..........#...#............#...#.#....#.............##..............##.#...................#..
...#..................#.#...#...#.........#...........#.....#...#.##........#.#....#..........#.......##...........................
.........#.#..........##.#....................#....#................#..#.#.....#...........#.........####.............#.......##...
.#......#...................#........#.......#........#...#..#..........#..##..#..........#........................................
.....#....#..#................##.....#......#.........................#.###...................#..#................#..#......#......
..............#..........................................#.........#.....##.###............#...##.....................##...........
..#......#..#.#.#.........#...#....................#.........#.........#......#...#.....................................#..........
.......#...#.................#..........................#...##..#...#.#.........##............#..................#...............#.
....#.........#.............#.......#.#..........#................#..##.#.#.#...................#.....#............#.....##....#...
.###...............................#.........#..............#.#......#......#.....##.#.#.......#................#.#..............#.
...#........#......#........................#.......#.##...#.........#........#...#.......#..##....#...........#....#..##..........
......#.......#........#.......#..#...#....#.......#....#.#..........##........#..#...............#.......................##..#....
...................#....#..........#........#.............#...#...##...#..........#.......#...#............#..........##...........
.#........##......#.#................#.....#..........#....###................#.....#.......###...............#...#..........#..#..
...#.........#...#....#............#..................##....#......#.....#.......#..........#...#...........#.....#..#.......#.....
........#.................#........#.........#...............#...........#.##...##.......#..................#.......#....##........
.###......#.....#......#.....................##..#...#........#........#....#................................#....#.....#.#........
...........##..............................#..#...........#....#...#......#.#..#......#...............#............................
.....#.#..#.........#............................#.....#.#.##......#.#.........#.....#.#...........................#...##......#.#.
..............#.#.#.....#.#.............#..#.#.....#....#..#.#....#.................#....................#..........#........#.....
..........#.....##.......#................#....................................#..#......#.........#..............#...#......##....
.##.#......###..............#.#...............###......#.................#.......#......#.............................#....#.#.....
..#..#...#............#....##.............#........................#.#..................................#......................#...
......#.....#.............#...#............#....#.......#.....#.................................#..##...#.#..............#.........
...........#..........#..#.#..................##...........#.......#........#....#.............#....................#.....#........
....#...........#........##........................................#.#...............#.............#.#...##...#........#...........
...#..#..............................................................#...#.#...#..#...........#..#..#....#..#..#.......#..#........
...................#.#.....##...........................#................#.#...#...........#.............................#.........
.....###.........#.....#...#...##...#..#........###.....#..#..............#.....#...................#...#...........#...#..........
..............#......................................#..#....#.........##....##..#.......#.......................#.....##..........
..#...................#...........#................................#.....#.#.#..........................#....#......#......#.......
..#......#....#..##..#....#............#...........###........................#.........#........#........#............#.........#.
...................#.##...........#....#..##............#...................#.........#........##........#...........#.#...........
...#.#......#....#........#.......#....................................#.##..#.........#....#.#.....#.........................#..#.
....#.#...#...........................................#...#..#....#....#..............#.........................#.....#......#..#..
......#..................#..........#..#....#.......................#...............#...........#..............#....#.#............
.#..............#........##......#...#....#...#.#................................................#.....##....#...##...#.#........#.
.........#.............#..#..#...........................#.............#...........................#....##............#............
..........#...#.....#..#...#...........#.#.......#........#.....................#.....#.....#...#.#..#......#....#....#...#..#.....
.#........#............##.................##...............#.....................#.##.................#........#......#............
....#........##....#..#.#.........#................................#................#.#.....#.............#..#....##.#....##.......
........#.#.....#.......#.#..##..............##...................#...................#..#....................#..#.......#...#.##..
.....#.#.........#.#....###..#..#.......#.....#................#....#........#.....................#.###.....#...........#......#..
......#...#................#..#...##............#......#...................#............................#.........#....##...##.....
..........#...##.....#....#...........#.....#......#..#.......................##...#.##.....#...#..##...#...#..#..#..........#...#.
......#............#...........#.#..#...............#.............................#..#.......#...#.................#.......#....#..
..............#........#............#....#.....##...#.###...................#............#..#.#..................#.............#...
.............#....#.......#..#......#....#...#..#.......##.............#.##...#.........#..........................#.#...........#.
.#..............#...#......#.......#..#................#.#.............#....#...............#.......#..............................
...................................................................................................................................";

var smallInput =
@"...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........";

var smallest = "";

var input = smallInput;
input = fullInput;
//input = smallest;
var timer = System.Diagnostics.Stopwatch.StartNew();

var result = 0l;

var grid = Utils.ParseCoordGrid(input).ToList();
var width = grid.Max(x => x.x) + 1;
var height = grid.Max(x => x.y) + 1;

var unvisitable = grid.Where(x => x.c == '#').Select(x => (x.x, x.y)).ToHashSet();
(int x, int y) Mod((int x, int y) n) => (Utils.SafeMod(n.x, width), Utils.SafeMod(n.y, height));
bool Visitable((int x, int y) n) => !unvisitable.Contains(Mod(n));
var start = grid.Single(x => x.c == 'S');

//Utils.PrintGrid(grid, x => x.x, x => x.y, x => x.c.ToString());

var s = grid.Single(x => x.c == 'S');

var steps = 12000;


//var visited = new HashSet<(int x, int y)> { (s.x, s.y) };

var toVisit = new HashSet<(int x, int y)>() { (s.x, s.y) };

Utils.PrintGrid(toVisit, x => x.x, y => y.y, x => "0", 15, 15, -15, -15, (x, y) => Visitable((x, y)) ? "." : "#");

var prevs = new List<int>() { 1 };
int prev = 0;
int prevCount = 0;
for (var i = 1; i < steps; i++)
{
    IEnumerable<(int x, int y)> Get((int x, int y) item)
    {
        foreach (var d in new[] { (1, 0), (-1, 0), (0, -1), (0, 1), })
        {
            var newCoord = (item.x + d.Item1, item.y + d.Item2);
            if (!Visitable(newCoord)) { continue; }
            yield return newCoord;
        }
    }

    toVisit = toVisit.SelectMany(Get).ToHashSet();
    //Console.Clear();
    var added = toVisit.Count - prevCount;
    prevCount = toVisit.Count;
    var tHeight = toVisit.Max(x => x.y) + 1 - toVisit.Min(x => x.y);
    var tWidth = toVisit.Max(x => x.x) + 1 - toVisit.Min(x => x.x);
    var t = tHeight * tWidth;
    //Console.WriteLine($"{i} {toVisit.Count} {added} {(double)toVisit.Count / i} {(double)added / i}");
    Console.WriteLine($"{i}\t{toVisit.Count}\t{t}\t{(double)added/i}\t{added - prev}\t{prevs.Average()}");
    prevs.Add(added - prev);
    prev = added;
    //Utils.PrintGrid(toVisit, x => x.x, y => y.y, x => "0", nullPrint: (x, y) => Visitable((x, y)) ? "." : " ");
}

result = toVisit.Count;


timer.Stop();
Console.WriteLine(result); // 6849 too high
Console.WriteLine(timer.ElapsedMilliseconds + "ms");
Console.ReadLine();