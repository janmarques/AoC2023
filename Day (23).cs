using System.Text;

var fullInput =
@"#S###########################################################################################################################################
#...#.....#.........#...#.......#...#...###...#...#...###...#...............#.........#.......#.....#...#...#.........#.....#...###.........#
###.#.###.#.#######.#.#.#.#####.#.#.#.#.###.#.#.#.#.#.###.#.#.#############.#.#######.#.#####.#.###.#.#.#.#.#.#######.#.###.#.#.###.#######.#
###...#...#.......#.#.#.#...#...#.#.#.#...#.#.#.#.#.#...#.#.#.#.......#.....#...#.....#...#...#...#.#.#.#.#.#.#.....#.#...#.#.#...#.......#.#
#######.#########.#.#.#.###.#.###.#.#.###.#.#.#.#.#.###.#.#.#.#.#####.#.#######.#.#######.#.#####.#.#.#.#.#.#.#.###.#.###.#.#.###.#######.#.#
#.......#.....#...#.#.#.#...#.>.>.#.#.#...#.#.#.#.#.#...#.#.#...#...#.#.#...###.#...#...#.#.#.....#.#.#...#.#...###.#.#...#.#...#.....###.#.#
#.#######.###.#.###.#.#.#.#####v###.#.#.###.#.#.#.#.#.###.#.#####.#.#.#.#.#.###.###.#.#.#.#.#.#####.#.#####.#######.#.#.###.###.#####.###.#.#
#...#...#...#.#...#.#.#.#.....#...#...#...#.#.#.#.#.#.#...#.>.>.#.#...#.#.#.>.>.#...#.#.#.#.#...#...#.....#.###.....#.#.#...###.#.....#...#.#
###.#.#.###.#.###.#.#.#.#####.###.#######.#.#.#.#.#.#.#.#####v#.#.#####.#.###v###.###.#.#.#.###.#.#######.#.###.#####.#.#.#####.#.#####.###.#
###...#...#.#.#...#.#.#.#.....###.......#...#...#.#.#.#.#.....#...#...#...#...###...#.#.#.#...#.#.#...#...#.#...#.....#.#.#...#.#.....#...#.#
#########.#.#.#.###.#.#.#.#############.#########.#.#.#.#.#########.#.#####.#######.#.#.#.###.#.#.#.#.#.###.#.###.#####.#.#.#.#.#####.###.#.#
#.........#.#...###.#.#.#.#...#.........###...#...#.#...#.#.........#...###.......#...#.#...#...#...#.#.#...#...#.#...#.#.#.#.#.#.....#...#.#
#.#########.#######.#.#.#.#.#.#.###########.#.#.###.#####.#.###########.#########.#####.###.#########.#.#.#####.#.#.#.#.#.#.#.#.#.#####.###.#
#.#...#...#.......#.#.#.#.#.#.#.............#.#...#.....#...###.........#.........#.....#...#.......#.#.#.#...#.#.#.#.#.#.#.#.#.#...#...#...#
#.#.#.#.#v#######.#.#.#.#.#.#.###############.###.#####.#######.#########.#########.#####.###.#####.#.#.#.#.#.#.#.#.#.#.#.#.#.#.###.#.###.###
#...#...#.>.#.....#...#...#.#...............#.###.....#.#.......#...#####.........#...#...###.#...#...#.#...#...#.#.#.#.#.#.#.#...#.#.#...###
#########v#.#.#############.###############.#.#######.#.#.#######.#.#############.###.#.#####.#.#.#####.#########.#.#.#.#.#.#.###.#.#.#.#####
#.........#...###.....#.....#.............#.#...#...#...#...#...#.#.....#.......#...#.#...###.#.#...###.........#...#...#...#.#...#.#.#.....#
#.###############.###.#.#####.###########.#.###.#.#.#######.#.#.#.#####.#.#####.###.#.###.###.#.###.###########.#############.#.###.#.#####.#
#.#.....#...#.....#...#.....#.#...........#.....#.#...#.....#.#...#.....#.#...#.....#.....#...#.###...>.>...#...###.........#...###.#.#.....#
#.#.###.#.#.#.#####.#######.#.#.#################.###.#.#####.#####.#####.#.#.#############.###.#######v###.#.#####.#######.#######.#.#.#####
#.#.###...#...#.....#...###...#.............#...#.#...#.......#...#.....#...#.....#.......#...#.#.......#...#.....#...#.....###...#.#.#.....#
#.#.###########.#####.#.###################.#.#.#.#.###########.#.#####.#########.#.#####.###.#.#.#######.#######.###.#.#######.#.#.#.#####.#
#...#...........#...#.#.#...#...#.........#...#...#.#...........#.......#.......#.#.#.....###...#.......#.........#...#.....#...#.#.#.#.....#
#####.###########.#.#.#.#.#.#.#.#.#######.#########.#.###################.#####.#.#.#.#################.###########.#######.#.###.#.#.#.#####
#...#...........#.#...#.#.#.#.#.#.......#.#...#...#.#.#.................#.....#...#.#.....#...#...#...#...#...#...#...#.....#.#...#...#.....#
#.#.###########.#.#####.#.#.#.#.#######.#.#.#.#.#.#.#.#.###############.#####.#####.#####.#.#.#.#.#.#.###.#.#.#.#.###.#.#####.#.###########.#
#.#...........#...#.....#.#.#.#.#.......#...#.#.#...#.#.#...............#...#.....#.#.....#.#.#.#.#.#.###...#.#.#.#...#.#.....#.#...#.......#
#.###########.#####.#####.#.#.#.#.###########.#.#####.#.#.###############.#.#####.#.#.#####.#.#.#.#.#.#######.#.#.#.###.#.#####.#.#.#.#######
#...........#.......#.....#.#.#.#...........#...#...#...#...#.......#...#.#.......#.#.#...#.#.#.#.#.#.#...#...#.#.#...#.#.....#.#.#.#...#...#
###########.#########.#####.#.#.###########.#####.#.#######.#.#####.#.#.#.#########.#.#.#.#.#.#.#.#.#.#.#.#.###.#.###.#.#####.#.#.#.###v#.#.#
#...#.......#...#...#...#...#.#.#...#.......#...#.#.###...#...#...#...#.#.#.....#...#.#.#.#.#.#.#.#.#.#.#.#.###.#...#.#.#...#.#.#.#.#.>.#.#.#
#.#.#.#######.#v#.#.###.#.###.#.#.#.#.#######.#.#.#.###.#.#####.#.#####.#.#.###.#.###.#.#.#.#.#.#.#.#.#.#.#v###.###.#.#.#.#.#.#.#.#.#.#v#.#.#
#.#.#.........#.>.#...#.#.#...#...#.#.....#...#.#.#.#...#.#.....#.......#...#...#.#...#.#.#.#...#.#.#.#.#.>.>...###.#.#.#.#.#.#.#.#.#.#...#.#
#.#.###########v#####.#.#.#.#######.#####.#.###.#.#.#.###.#.#################.###.#.###.#.#.#####.#.#.#.###v#######.#.#.#.#.#.#.#.#.#.#####.#
#.#.............#.....#.#.#.....#...#.....#.#...#.#.#.#...#...#.....#.....#...#...#...#.#.#.#...#...#.#.###.......#.#.#.#.#...#...#...#...#.#
#.###############.#####.#.#####.#.###v#####.#.###.#.#.#.#####.#.###.#.###.#.###.#####.#.#.#.#.#.#####.#.#########.#.#.#.#.#############.#.#.#
#.#...#.........#.....#.#.#...#.#...>.>.....#.#...#...#.#####...#...#.#...#...#.....#.#.#.#...#.###...#.#.........#...#...#...###...#...#...#
#.#.#.#.#######.#####.#.#.#.#.#.#####v#######.#.#######.#########.###.#.#####v#####.#.#.#.#####.###.###.#.#################.#.###.#.#.#######
#...#...#.......###...#.#.#.#.#...#...#.......#.......#...#...###...#.#...#.>.>.....#...#.#.....#...#...#...........#.......#...#.#.#.....###
#########.#########.###.#.#.#.###.#.###.#############.###.#.#.#####.#.###.#.#v###########.#.#####.###.#############.#.#########.#.#.#####.###
#.........#.....#...#...#.#.#.#...#...#.#...#...#...#.#...#.#.#...#.#...#...#.......#.....#.....#...#.#.............#.......#...#.#.#...#...#
#.#########.###.#.###.###.#.#.#.#####.#.#.#.#.#.#.#.#.#.###.#.#.#.#v###.###########.#.#########.###.#.#.###################.#.###.#.#.#.###.#
#...........#...#...#.#...#.#.#.#.....#.#.#...#.#.#.#.#...#.#...#.>.>...#...........#.....#.....###...#.............###...#.#.....#...#.#...#
#############.#####.#.#.###.#.#.#.#####.#.#####.#.#.#.###.#.#######v#####.###############.#.#######################.###.#.#.###########.#.###
###...#.......#####.#.#.#...#...#.....#.#.#.....#.#...###...#...###.#.....#.............#.#...#...#...#...........#.#...#...#.......#...#...#
###.#.#.###########.#.#.#.###########.#.#.#.#####.###########.#.###.#.#####.###########.#.###.#.#.#.#.#.#########.#.#.#######.#####.#.#####.#
#...#...#.........#.#.#.#.#...........#...#...#...###...###...#.#...#...#...#.......#...#.#...#.#.#.#.#.........#...#.#.......#...#.#.#...#.#
#.#######.#######.#.#.#.#.#.#################.#.#####.#.###.###.#.#####.#.###.#####.#.###.#.###.#.#.#.#########.#####.#.#######.#.#.#.#.#.#.#
#.........#.......#...#...#.............#...#.#.#...#.#.#...###.#.....#...###.....#.#.#...#.#...#.#.#...#...#...#.....#...#.....#...#...#.#.#
###########.###########################.#.#.#.#.#.#.#.#.#.#####.#####.###########.#.#.#.###.#.###.#.###.#.#.#.###.#######.#.#############.#.#
#.......###.#...#...#...#...............#.#.#...#.#.#.#.#.....#.#...#...#.........#...#.....#...#.#...#.#.#...###.........#...........###...#
#.#####.###.#.#.#.#.#.#.#.###############.#.#####.#.#.#.#####.#.#.#.###.#.#####################.#.###.#.#.###########################.#######
#.#...#.....#.#.#.#...#.#.............#...#.....#.#.#.#.....#.#...#.....#.#...........#...#...#.#.....#.#...........#...............#.......#
#.#.#.#######.#.#.#####.#############.#.#######.#.#.#v#####.#.###########.#.#########.#.#.#.#.#.#######.###########.#.#############.#######.#
#...#.......#.#.#.#.....#...#...#.....#.......#.#.#.>.>...#...###...#...#.#.#.........#.#.#.#...#.....#.............#.........#...#.........#
###########v#.#.#.#.#####.#.#.#.#.###########.#.#.###v###.#######.#.#.#.#.#.#.#########.#.#.#####.###.#######################.#.#.###########
###...#...#.>.#...#.....#.#.#.#.#...###...#...#.#.###...#...#...#.#.#.#.#...#...#...###.#.#.......###.........#...###...###...#.#.###.......#
###.#.#.#.#v###########.#.#.#.#.###.###.#.#.###.#.#####.###.#.#.#.#.#.#.#######.#.#.###.#.###################.#.#.###.#.###v###.#.###.#####.#
#...#...#.#.....#.......#.#.#.#...#.#...#.#...#.#.#.....#...#.#...#.#.#...#...#...#.#...#.#...###...###...###.#.#.#...#...>.#...#.....#...#.#
#.#######.#####.#.#######.#.#.###.#.#.###.###.#.#.#.#####.###.#####.#.###.#.#.#####.#.###.#.#.###.#.###.#.###v#.#.#.#######v#.#########.#.#.#
#.......#.......#.......#.#.#.#...#.#...#.....#...#.....#...#.....#.#.#...#.#.#.....#...#.#.#...#.#.#...#.#.>.>.#...#.......#...#.......#...#
#######.###############.#.#.#.#.###.###.###############.###.#####.#.#.#.###.#.#v#######.#.#.###.#.#.#.###.#.#v#######.#########.#.###########
#.......#...#...#.......#.#.#.#...#.###.............#...###.#...#.#.#.#...#.#.>.>.....#.#.#...#.#.#.#.###...#.......#...#.......#...........#
#.#######.#.#.#.#.#######.#.#.###.#.###############.#.#####.#.#.#.#.#.###.#.###v#####.#.#.###.#.#.#.#.#############.###.#.#################.#
#.......#.#...#.#...#...#.#.#.#...#.#...........#...#.....#...#.#.#.#.###.#.#...#...#...#...#.#.#.#.#.#.............#...#.#.................#
#######.#.#####.###.#.#.#.#.#.#.###v#.#########.#.#######.#####.#.#.#.###.#.#.###.#.#######.#.#.#.#.#.#.#############.###.#.#################
#.......#.#.....###...#.#.#.#.#...>.>.#...#...#.#.#.....#.....#.#.#.#.#...#.#...#.#.......#.#.#.#.#...#.........#...#.....#.....#...........#
#.#######.#.###########.#.#.#.#####v###.#.#.#.#.#.#.###.#####.#.#.#.#.#.###.###.#.#######.#.#.#.#.#############.#.#.###########.#.#########.#
#...#...#.#...........#.#.#...#...#.....#...#.#.#.#...#.......#...#...#...#.###...#.......#...#.#.#.......#.....#.#.#...........#.#.........#
###.#.#.#.###########.#.#.#####.#.###########.#.#.###.###################.#.#######.###########.#.#.#####.#.#####.#.#.###########.#.#########
###.#.#.#.#...........#.#.#.....#.#...###.....#...###...........###...###...#.......###...#...#...#.....#...###...#.#.............#.........#
###.#.#.#.#.###########.#.#.#####.#.#.###.#####################.###.#.#######.#########.#.#.#.#########.#######.###.#######################.#
#...#.#...#...#.......#...#.....#.#.#...#...#...#...............#...#...#...#...........#...#.###...###.........#...#...........#...........#
#.###.#######.#.#####.#########.#.#.###.###.#.#.#.###############.#####.#.#.#################.###.#.#############.###.#########.#.###########
#.....#.....#.#.#.....#...#...#.#.#.#...#...#.#.#...........#...#...#...#.#.###.......#.......#...#.#.............###.........#.#.....#...###
#######.###.#.#.#v#####.#.#.#.#.#.#.#.###v###.#.###########.#.#.###.#.###.#.###.#####.#.#######.###.#.#######################.#.#####.#.#.###
#...###...#.#...#.>...#.#.#.#.#.#.#.#.#.>.>...#.....#.......#.#...#.#.#...#...#.#...#...###...#...#.#.......#.......#.....#...#.....#...#...#
#.#.#####.#.#####v###.#.#.#.#.#.#.#.#.#.#v#########.#.#######.###.#.#.#.#####.#.#.#.#######.#.###.#.#######.#.#####.#.###.#.#######.#######.#
#.#.......#.......###.#.#.#.#.#.#...#...#.#.........#.......#.#...#.#.#.....#.#...#.#.....#.#.#...#.#...#...#...#...#...#.#...#...#.#.......#
#.###################.#.#.#.#.#.#########.#.###############.#.#.###.#.#####.#.#####v#.###.#.#.#.###.#.#.#.#####.#.#####.#.###v#.#.#.#.#######
#.#...............###...#.#.#.#.#.........#.........#...#...#.#...#.#...#...#.#...>.>.#...#.#.#...#.#.#.#...###.#.#...#.#.#.>.#.#.#...#...###
#.#.#############.#######.#.#.#.#.#################.#.#.#.###.###.#.###.#.###.#.###v###.###.#.###.#.#.#.###.###.#.#.#.#.#.#.#v#.#.#####.#.###
#.#.#.............#...###...#...#.......#.......#...#.#.#...#.###...###.#...#...#...###...#.#.###.#.#.#.#...#...#.#.#.#.#...#...#...###.#.###
#.#.#.#############.#.#################.#.#####.#.###.#.###.#.#########.###.#####.#######.#.#.###.#.#.#.#v###.###.#.#.#.###########.###.#.###
#.#.#...#...#...#...#...#...#...#...#...#.....#.#.#...#.#...#.........#.#...#...#.....#...#.#.#...#.#.#.>.>...###.#.#.#.#.........#.....#...#
#.#.###.#.#.#.#.#.#####.#.#.#.#.#.#.#.#######.#.#.#.###.#.###########.#.#.###.#.#####.#.###.#.#.###.#.###v#######.#.#.#.#.#######.#########.#
#.#.###...#...#...#.....#.#...#.#.#.#.#.......#...#...#.#...#...#...#.#.#.#...#.......#...#.#.#...#.#.###...#...#...#.#.#.......#...#...#...#
#.#.###############.#####.#####.#.#.#.#.#############.#.###v#.#.#.#.#.#.#.#.#############.#.#.###.#.#.#####.#.#.#####.#.#######.###.#.#.#.###
#.#.#.............#.....#.....#...#.#.#...#...#...#...#...>.>.#...#...#...#.............#.#.#...#.#...#.....#.#.#...#...###...#...#.#.#.#...#
#.#.#.###########.#####.#####.#####.#.###.#.#.#.#.#.#######v###########################.#.#.###.#.#####.#####.#.#.#.#######.#.###.#.#.#.###.#
#.#.#...........#.#.....#####.....#...###.#.#.#.#.#.#.......#.......#...#.............#.#.#...#...###...#.....#.#.#.....#...#.....#...#.....#
#.#.###########.#.#.#############.#######.#.#.#.#.#.#.#######.#####.#.#.#.###########.#.#.###.#######.###.#####.#.#####.#.###################
#.#.#...........#...#...#.......#.......#.#.#.#.#...#.......#.#.....#.#.#...........#...#...#...#...#...#.#.....#.#.....#...#.....#.........#
#.#.#.###############.#.#.#####.#######.#.#.#.#.###########.#.#.#####.#.###########.#######.###.#.#.###.#.#.#####.#.#######.#.###.#.#######.#
#.#.#...............#.#.#.....#.........#.#.#.#.#.........#...#...#...#.#...###.....#.....#.....#.#...#...#.......#.#...#...#.#...#.#.......#
#.#.###############.#.#.#####.###########.#.#.#.#.#######.#######.#.###.#.#.###.#####.###.#######.###.#############.#.#.#.###.#.###.#.#######
#...###...........#...#...###...........#.#.#...#.......#.#.......#...#.#.#...#.....#.#...#.....#.#...#...#.......#...#.#.....#.....#.......#
#######.#########.#######.#############.#.#.###########.#.#.#########.#.#.###.#####.#.#.###.###.#.#.###.#.#.#####.#####.###################.#
#...#...#.......#.........#.......#.....#...###...#.....#...#...#...#.#.#.#...#.....#.#...#.#...#.#...#.#.#.....#.#...#.#.......#.....#.....#
#.#.#.###.#####v###########.#####.#.###########.#.#.#########.#.#.#.#.#.#.#.###v#####.###.#.#.###.###.#.#.#####.#.#.#.#.#.#####.#.###.#.#####
#.#...#...#...#.>.#...#...#...###...#...........#.#.....###...#.#.#...#.#.#...>.>...#.#...#.#...#.#...#.#.#...#.#...#...#.....#.#...#.#.....#
#.#####.###.#.#v#.#.#.#.#.###v#######.###########.#####.###.###.#.#####.#.#####v###.#.#.###.###.#.#.###.#.#.#.#.#############.#.###.#.#####.#
#.....#.#...#...#...#.#.#...>.>.#...#.....#.......#...#...#...#.#.#.....#...#...###...#.#...#...#.#.#...#.#.#.#...#...#.......#.#...#.#.....#
#####.#.#.###########.#.#####v#.#.#.#####.#.#######.#.###.###.#.#.#.#######.#.#########.#.###.###.#.#.###.#.#.###.#.#.#.#######.#.###.#.#####
#####...#...........#...###...#...#.#.....#.....#...#.....#...#.#.#...#.....#.......###.#.#...###.#.#...#.#.#.#...#.#.#.....###...###.#.....#
###################.#######.#######.#.#########.#.#########.###.#.###.#.###########.###.#.#.#####.#.###.#.#.#.#v###.#.#####v#########.#####.#
#...................#.....#...#.....#.....#.....#.......#...###.#.###...#...#...#...#...#.#.#.....#...#.#.#.#.>.>.#.#.....>.#.....###.#.....#
#.###################.###.###.#.#########.#.###########v#.#####.#.#######.#.#.#.#.###.###.#.#.#######.#.#.#.###v#.#.#######v#.###.###.#.#####
#...#...............#...#.....#...#.....#.#...#...#...>.>.#...#.#.#.......#...#...###...#.#.#.......#...#...#...#.#.#.......#...#...#.#.....#
###.#.#############.###.#########.#.###.#.###.#.#.#.###v###.#.#.#.#.###################.#.#.#######.#########.###.#.#.#########.###.#.#####.#
###...#.............###...#.....#...###...###...#.#.#...###.#.#...#.#.....#...#...#...#...#.........###...#...###...#...........#...#.....#.#
#######.#################.#.###.#################.#.#.#####.#.#####.#.###.#.#.#.#.#.#.#################.#.#.#####################.#######.#.#
#.....#.............#.....#.###...#...###...#.....#.#.......#.....#...###...#...#...#.....###...###.....#...#.........#...#.......#...###...#
#.###.#############.#.#####.#####.#.#.###.#.#.#####.#############.#######################.###.#.###.#########.#######.#.#.#.#######.#.#######
#...#...............#.#.....#...#...#...#.#...#.....#.............#...............#.....#.....#...#.....#...#.#.......#.#.#.......#.#.......#
###.#################.#.#####.#.#######.#.#####.#####.#############.#############.#.###.#########.#####.#.#.#.#.#######.#.#######.#.#######.#
###...#...#.....#...#...#.....#.......#.#...#...#.....#...#...#...#...........###...###.#.........#...#.#.#...#...#.....#.........#.#.......#
#####.#.#.#.###.#.#.#####.###########.#.###.#.###.#####.#.#.#.#.#.###########.#########.#.#########.#.#.#.#######.#.###############.#.#######
#####...#...###...#.....#.......#...#...###...###...#...#...#.#.#.#...#...###...#...###...#.....###.#.#...#.....#.#.#...#.....#...#.#.#...###
#######################.#######.#.#.###############.#.#######.#.#.#.#.#.#.#####.#.#.#######.###.###.#.#####.###.#.#.#.#.#.###.#.#.#.#.#.#.###
#.......................###...#...#.........#...#...#.#.......#.#.#.#.#.#.###...#.#...#...#.#...#...#.......###...#...#...#...#.#...#...#...#
#.#########################.#.#############.#.#.#.###.#.#######.#.#.#.#.#.###v###.###.#.#.#.#.###.#########################.###.###########.#
#.................#.....#...#.#.............#.#.#.....#...###...#.#.#.#.#.#.>.>.#.#...#.#...#...#...#.......#...#...#...#...#...#...........#
#################.#.###.#.###.#.#############.#.#########v###.###.#.#.#.#.#.###.#.#.###.#######.###.#.#####.#.#.#.#.#.#.#.###.###.###########
#...#...#...###...#.#...#...#.#.....#.......#.#.#.......>.>.#...#...#.#.#...#...#.#...#.....#...#...#.#.....#.#.#.#.#.#.#...#.#...#...#.....#
#.#.#.#.#.#.###.###.#.#####.#.#####.#.#####.#.#.#.#########.###.#####.#.#####.###.###.#####.#.###.###.#.#####.#.#.#.#.#.###v#.#.###.#.#.###.#
#.#...#...#.....###.#...#...#.#...#.#.#.....#.#.#.......#...#...#.....#.....#...#.#...#...#.#...#.....#.....#.#.#.#.#.#.#.>.#.#...#.#.#.#...#
#.#################.###.#.###.#.#.#.#.#.#####.#.#######.#.###.###.#########.###.#.#.###.#.#.###.###########.#.#.#.#.#.#.#.#v#.###.#.#.#.#.###
#.........#.....#...#...#...#...#.#...#...#...#.#...#...#.....###...#.....#...#.#.#.#...#.#.#...#...#.......#.#...#...#...#.#.#...#.#.#.#...#
#########.#.###.#.###.#####.#####.#######.#.###.#.#.#.#############.#.###.###.#.#.#.#.###.#.#.###.#.#.#######.#############.#.#.###.#.#.###.#
#...#...#.#...#.#.#...#...#...#...#...###.#...#.#.#.#.........#...#.#...#.#...#...#.#.#...#.#...#.#.#.......#.............#...#.....#.#.#...#
#.#.#.#.#.###.#.#.#.###.#.###.#.###.#.###v###.#.#.#.#########.#.#.#.###.#.#.#######.#.#.###.###.#.#.#######v#############.###########.#.#.###
#.#...#...#...#...#...#.#...#.#...#.#.#.>.>.#.#.#.#.#.....#...#.#.#.#...#.#...#.....#.#...#.#...#.#.#...#.>.>.#...#...#...#...........#.#...#
#.#########.#########.#.###.#.###.#.#.#.###.#.#.#.#.#.###.#.###.#.#.#.###.###.#.#####.###.#.#.###.#.#.#.#.###.#.#.#.#.#.###.###########.###.#
#...#.......###.......#...#...###.#.#...###.#.#.#.#.#...#.#...#.#...#.#...#...#...#...#...#.#...#.#...#.#.###...#.#.#.#.#...#.....#...#.#...#
###.#.#########.#########.#######.#.#######.#.#.#.#.###.#.###.#.#####.#.###.#####.#.###.###.###.#.#####.#.#######.#.#.#.#.###.###.#.#.#.#.###
#...#.#.........#...#...#.#.......#.......#.#.#.#.#.#...#.#...#...#...#...#.....#.#.###...#.###.#.#.....#...#.....#.#.#.#...#.#...#.#.#.#.###
#.###.#.#########.#.#.#.#.#.#############.#.#.#.#.#.#.###.#.#####.#.#####.#####.#.#.#####.#.###.#.#.#######.#.#####.#.#.###.#.#.###.#.#.#.###
#.....#...........#...#...#...............#...#...#...###...#####...#####.......#...#####...###...#.........#.......#...###...#.....#...#...#
###########################################################################################################################################E#";

var smallInput =
@"#S#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################E#";



var input = smallInput;
input = fullInput;
//input = smallest;
var timer = System.Diagnostics.Stopwatch.StartNew();

var result = long.MaxValue;

var gridInput = input.Split(Environment.NewLine).Select(x => x.ToArray()).ToArray();
var grid = new List<(short x, short y)>();
var slopes = new Dictionary<(short x, short y), char>();
var height = gridInput.Count();
var width = gridInput[0].Count();

var start = default((short, short));
var target = default((short, short));

var directions = new[] {
    (icon: '>', x: 1, y: 0),
    (icon: '<', x: -1, y: 0),
    (icon: '^', x: 0, y: -1),
    (icon: 'v', x: 0, y: 1),
};


for (short y = 0; y < height; y++)
{
    for (short x = 0; x < width; x++)
    {
        var item = gridInput[y][x];
        if (item != '#')
        {
            var entry = (x, y);
            grid.Add(entry);
            if (item == 'S')
            {
                start = entry;
            }
            if (item == 'E')
            {
                target = entry;
            }
            if (directions.Select(x => x.icon).Contains(item))
            {
                slopes[entry] = item;
            }
        }
    }
}


List<(short x, short y)> bestPath = null;
var pq = new PriorityQueue<(List<(short x, short y)> maze, (short x, short y) position, char facing, long score, List<string> pathTaken), long>();
pq.Enqueue((maze: grid, position: start, facing: 'v', 0, new List<string> { Hash(start.Item1, start.Item2) }), 0);

string Hash(short x, short y) => $"{x},{y}";
char InverseDirection(char x)
    => x switch
    {
        '>' => '<',
        '<' => '>',
        '^' => 'v',
        'v' => '^',
        _ => throw new NotImplementedException()
    };


int i = 0;


var results = new HashSet<long>();
var paths = new List<List<string>>();

var deadends = new HashSet<(short x, short y)>();
while (pq.Count > 0)
{
    var (maze, position, facing, score, pathTaken) = pq.Dequeue();
    if (i % 100 == 0)
    {
        Console.WriteLine($"{i}i {pq.Count}queue {score}score {deadends.Count}dead");
    }
    i++;

    maze = maze.Except(deadends).ToList();
    if (score > result)
    {
        //break;
    }
    if (position == target)
    {
        results.Add(score);
        result = Math.Min(result, score);
        paths.Add(pathTaken);
        if (score == result)
        {
            //bestPath = pathTaken;
        }
    }

    var deadEnd = 3;
    foreach (var direction in directions.Where(x => x.icon != InverseDirection(facing)))
    {
        var other = maze.SingleOrDefault(x => x.x == position.x + direction.x && x.y == position.y + direction.y);
        var hash = Hash(other.x, other.y);
        if (other == default || deadends.Contains(other)) { deadEnd--; continue; }
        if (pathTaken.Contains(hash)) { continue; }
        if (slopes.TryGetValue((other.x, other.y), out var slope))
        {
            if (InverseDirection(slope) == direction.icon)
            {
                continue;
            }
        }

        var cost = 1;
        var newTotal = score + cost;
        var newPathTaken = pathTaken.ToList();
        newPathTaken.Add(hash);
        pq.Enqueue((maze.Where(x => x != position).ToList(), other, direction.icon, newTotal, newPathTaken), newTotal);
    }
    if (deadEnd == 0)
    {
        //deadends.Add(position);
    }
}

foreach (var item in results)
{
    Console.WriteLine(item);
}

bestPath = paths.Last().Select(x => x.Split(",").Select(short.Parse)).Select(x => (x: x.ElementAt(0), y: x.ElementAt(1))).ToList();
PrintGrid();

timer.Stop();
Console.WriteLine(result);
Console.WriteLine(timer.ElapsedMilliseconds + "ms");
Console.ReadLine();

void PrintGrid()
{
    var sb = new StringBuilder();
    WriteGrid(sb);
    Console.WriteLine(sb);
}
void WriteGrid(StringBuilder sb)
{
    for (int y = 0; y < width; y++)
    {
        for (int x = 0; x < height; x++)
        {
            sb.Append(bestPath.SingleOrDefault(n => n.x == x && n.y == y) != default ? 'X' : '.');
        }
        sb.AppendLine();
    }
}